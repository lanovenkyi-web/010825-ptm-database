
`$switch` — это **условный оператор** в агрегатных пайплайнах MongoDB,  
аналог конструкции `CASE` в SQL
```sql
SELECT 
  name,
  CASE
    WHEN score >= 90 THEN 'A'
    WHEN score >= 75 THEN 'B'
    ELSE 'C'
  END AS grade
FROM students;
```

Или конструкции `match-case` в Python 3.10+
```pathon
value = 3

match value:
    case 1:
        print("Один")
    case 2:
        print("Два")
    case _:
        print("Что-то другое")
```
Он позволяет задать **несколько условий**, и вернуть значение по первому из них, 
которое выполнится.

---

## Синтаксис

```javascript
{
  $switch: {
    branches: [
      { case: <условие>, then: <значение> },
      { case: <условие>, then: <значение> },
      ...
    ],
    default: <значение по умолчанию>
  }
}
```

* `branches`: массив условий и соответствующих значений.
* `case`: выражение, возвращающее `true` или `false`.
* `then`: результат, возвращаемый при `true`.
* `default`: возвращается, если ни одно из условий не выполнилось.

---

## Пример

```js
db.students.aggregate([
  {
    $project: {
      name: 1,
      gradeCategory: {
        $switch: {
          branches: [
            { case: { $gte: ["$score", 90] }, then: "Отлично" },
            { case: { $gte: ["$score", 75] }, then: "Хорошо" },
            { case: { $gte: ["$score", 60] }, then: "Удовлетворительно" }
          ],
          default: "Неуд"
        }
      }
    }
  }
])
```

**Что делает**:

* Если `score ≥ 90` → "Отлично"
* Если `score ≥ 75` → "Хорошо"
* Если `score ≥ 60` → "Удовлетворительно"
* Иначе → "Неуд"

⚠️ Важно: **Проверка идёт сверху вниз**, и как только одно условие выполнится — остальные игнорируются.

---
## Пример "снизу вверх"
```javascript
db.getCollection('listingsAndReviews').aggregate(
  [
    {
      $project: {
        _id: {
          $switch: {
            branches: [
              { case: { $lt: ['$_id', 50] },  then: '< 50' },
              { case: { $lt: ['$_id', 100] }, then: '< 100' },
              { case: { $lt: ['$_id', 1000] }, then: '< 1000' }
            ],
            default: '≥ 1000'
          }
        }
      }
    }
  ]
);
```

---

## Когда использовать `$switch`

| Сценарий                                                          | Оператор  |
| ----------------------------------------------------------------- |-----------|
| Простая проверка `если — то — иначе`                              | `$cond`   |
| Несколько проверок `if / else if / else`                          | `$switch` |
| Нужно проверить поле на множество значений (аналог `switch-case`) | `$switch` |

---

## ⚠️ Ограничения

* Используется **только внутри агрегатных стадий** (`$project`, `$addFields`, `$group`, и т.д.).
* Нельзя использовать в `update`-операциях — там только `$cond`.

### Важно ❗  
В `$switch` нельзя использовать **query syntax** типа `{ _id: 0 }` или `{ _id: { $eq: 0 } }`.  
В **aggregation expressions** каждое выражение — это функция, а не фильтр: `{ $eq: ["$_id", 0 ] }`.
