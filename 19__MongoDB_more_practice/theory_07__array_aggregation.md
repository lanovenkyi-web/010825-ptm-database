### Ключи-агрегаторы могут работать с массивом напрямую

Начиная с MongoDB **5.0+** (частично раньше), некоторые агрегаторы можно использовать  
в стадиях `$project / $set / $addFields`:

```js
{
  $set: {
    avgScore: { $avg: "$grades.score" },
    firstGrade: { $first: "$grades.grade" }
  }
}
```

### Что реально происходит?

| Выражение                 | Поведение                            |
| ------------------------- | ------------------------------------ |
| `$avg: "$grades.score"`   | берёт массив чисел → считает среднее |
| `$first: "$grades.grade"` | берёт **первый элемент массива**     |
| `$last: "$grades.grade"`  | берёт последний                      |
| `$min / $max`             | минимум / максимум                   |
| `$sum`                    | сумма                                |


Для этого не требуется **не `$group`, не `$unwind`** ❗
Группировка как бы происходит внутри массива документа: **один документ → одно значение**

---

### Ограничения и подводные камни ⚠️

### `$first` и `$last` — не сортируют

```js
$first: "$grades.grade"
```

Это:

* первый элемент **как он лежит в массиве**
* **НЕ** первый по значению

Если нужен контроль порядка:

```js
$sortArray + $first
```

---

### `$avg` пропускает не-числа

```js
grades: [{ score: 5 }, { score: null }]
```

→ `avgScore = 5`

Если массив пустой → `null`

---

### Когда это лучше, чем `$unwind`?

* массив **внутри документа**
* не нужна группировка по документам всей коллекции
* не нужен `$match` по элементам массива
* не нужна сортировка внутри массива

---

### Когда всё же нужен `$unwind + $group`?

* нужно агрегировать **между документами**
* нужен `$match` по элементам массива
* нужна сложная логика с условиями
* нужны несколько уровней группировки

---

### Итоговая таблица (что и где работает)

| Оператор          | Тип                 | Где работает          | Работает <br>с массивом<br>напрямую | Назначение / комментарий                   |
| ----------------- | ------------------- | --------------------- |-------------------------------------| ------------------------------------------ |
| `$avg`            | accumulator         | `$group`, expressions | ✅                                   | Среднее значение                           |
| `$sum`            | accumulator         | `$group`, expressions | ✅                                   | Сумма значений массива                     |
| `$min`            | accumulator         | `$group`, expressions | ✅                                   | Минимум                                    |
| `$max`            | accumulator         | `$group`, expressions | ✅                                   | Максимум                                   |
| `$first`          | accumulator         | `$group`, expressions | ✅                                   | Первый элемент массива (как лежит)         |
| `$last`           | accumulator         | `$group`, expressions | ✅                                   | Последний элемент массива                  |
| `$stdDevPop`      | accumulator         | `$group`, expressions | ✅                                   | Стандартное отклонение (population)        |
| `$stdDevSamp`     | accumulator         | `$group`, expressions | ✅                                   | Стандартное отклонение (sample)            |
| `$push`           | accumulator         | **только `$group`**   | ❌                                   | Формирует массив из документов             |
| `$addToSet`       | accumulator         | **только `$group`**   | ❌                                   | Уникальные значения между документами      |
| `$sum: 1`         | accumulator-паттерн | `$group`              | ❌                                   | Подсчёт документов                         |
| `$size: "$array"` | замена `$sum: 1`    | expressions           | ✅                                   | Подсчёт элементов массива внутри документа |


