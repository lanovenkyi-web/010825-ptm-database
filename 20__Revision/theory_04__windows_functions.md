## Оконные функции в MongoDB

Оконные функции появились в MongoDB 5.0. 
Позволяют выполнять вычисления по группе документов, не сворачивая их в один документ,  
что неизбежно при обычной группировке.

Аналог оконных функций в MySQL


---

### Базовый синтаксис `$setWindowFields`

```js
{
  $setWindowFields: {
    partitionBy: <поле или выражение>, // аналог GROUP BY
    sortBy: { <поле>: 1 | -1 },        // порядок в окне
    output: {
      <новоеПоле>: {
        <оконная_функция>: <аргументы>,
        window: { ... }                // границы окна (необязательно)
      }
    }
  }
}
```

#### `partitionBy`

Разделяет документы на независимые «окна».

```js
partitionBy: "$userId"
```

→ расчёты отдельно для каждого пользователя.

#### `sortBy`

Определяет порядок документов внутри окна.

```js
sortBy: { createdAt: 1 }
```

Обязателен для: 
* функций ранжирования (`$rank`, `$shift`, `$denseRank` и др.).
* функций смещений (`$shift`, `$documentNumber`).
* кумулятивных функций (`$sum`, `$avg`, `$first`, `$last`).

#### `window`

Определяет, **какие документы участвуют в расчёте** (аналог фрейма в MySQL)

Типы окон:

* по количеству документов
* по диапазону значений

---

### Ограничения и нюансы

* Работают **только в aggregation pipeline**
* Могут быть ресурсоёмкими
* `sortBy` часто обязателен
* Индексы **не всегда** помогают (данные всё равно сортируются)

---

### Сравнение с SQL

#### Агрегация (суммирование, среднее и т.д.)

| Аспект                   | MySQL 8.0+          | MongoDB 5.0+              |
| ------------------------ | ------------------- | ------------------------- |
| Синтаксис                | `SUM(x) OVER (...)` | `$setWindowFields → $sum` |
| Сохранение строк         | ✅                   | ✅                         |
| PARTITION BY             | `PARTITION BY col`  | `partitionBy: "$col"`     |
| Выражения в PARTITION BY | ❌                   | ✅                         |
| Агрегация без сортировки | ✅                   | ✅                         |
| COUNT                    | `COUNT(*)`          | `$count`                  |
| Несколько агрегатов      | ✅                   | ✅                         |


#### Кумулятивная агрегация (running total)

| Аспект                  | MySQL                                              | MongoDB                               |
| ----------------------- | -------------------------------------------------- | ------------------------------------- |
| Поддержка               | ✅                                                  | ✅                                     |
| Синтаксис окна          | `ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW` | `documents: ["unbounded", "current"]` |
| Зависимость от ORDER BY | ✅                                                  | ✅                                     |
| RANGE по времени        | `RANGE INTERVAL`                                   | `window.range + unit`                 |
| Накопительная сумма     | `SUM(x)`                                           | `$sum`                                |
| Накопительное среднее   | `AVG(x)`                                           | `$avg`                                |


#### Функции смещения (доступ к соседним строкам)

| Аспект                | MySQL          | MongoDB             |
| --------------------- | -------------- | ------------------- |
| Предыдущая строка     | `LAG()`        | `$shift (by: -1)`   |
| Следующая строка      | `LEAD()`       | `$shift (by: 1)`    |
| Произвольное смещение | `LAG(x, n)`    | `by: -n`            |
| Значение по умолчанию | `LAG(x, n, d)` | ❌ (нужно `$ifNull`) |
| Требует ORDER BY      | ✅              | ✅                   |


#### Ранжирование

| Тип                  | MySQL            | MongoDB           |
| -------------------- | ---------------- | ----------------- |
| Плотный ранг         | `DENSE_RANK()`   | `$denseRank`      |
| Ранг с пропусками    | `RANK()`         | `$rank`           |
| Номер строки         | `ROW_NUMBER()`   | `$documentNumber` |
| PARTITION BY         | ✅                | ✅                 |
| ORDER BY             | ✅                | ✅                 |
| Управление tie-break | через `ORDER BY` | через `sortBy`    |

---



